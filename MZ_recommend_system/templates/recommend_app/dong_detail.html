{% extends "base.html" %}
{% block content %}
{% load static %}



<div class="pt-5">
  <div class="container">
    <div class="row">
      <div class="px-md-5 col-md-12">
        <h1 class="text-primary mb-4"> <b>{{data.dong_name}}</b></h1>
      </div>
    </div>
  </div>
</div>
<div class="py-5">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <ul class="nav nav-pills">
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabone"
              data-query="transportation">교통</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="safety">치안</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabthree"
              data-query="noise_vibration_num">조용한 동네</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="leisure_num">실내레저시설</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="gym_num">헬스장</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="golf_num">골프장</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="park_num">공원</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="facilities">편의시설</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="medical">의료시설</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="starbucks_num">스타벅스</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="mc_num">맥도날드</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="vegan_cnt">채식</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="coliving_num">코리빙</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="education">교육</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="parenting">육아</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="kids_num">키즈카페</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="ani_hspt_num">동물병원</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="safe_dlvr_num">안심택배</a> </li>
          <li class="nav-item"> <a class="nav-link infra" href="" data-toggle="pill" data-target="#tabtwo"
              data-query="car_shr_num">나눔카</a> </li>
          <li class="nav-item"> <a href="" class="nav-link infra" data-toggle="pill" data-target="#tabtwo"
              data-query="mz_pop_cnt">MZ세대 인구수</a> </li>
        </ul>
      </div>
    </div>
  </div>
</div>
<div class="py-5">
  <div class="container">
    <div class="row">


      <div id="map" style="width:100%;height:100vh;margin:0 auto;"></div>


    </div>
  </div>
</div>



<!--div class="col-md-5" style=""><img class="img-fluid d-block" src="https://static.pingendo.com/img-placeholder-1.svg"></div-->
</div>
</div>
</div>

<script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=liyb9vr43o"></script>


<script>

  const dongLat = '{{ dong_coordinate.lat }}'
  const dongLon = '{{ dong_coordinate.lon }}'
  console.log(typeof(dongLat))
  console.log(typeof(dongLon))
  console.log(dongLat)
  console.log(dongLon)
  var HOME_PATH = window.HOME_PATH || '.';
  var markers = [];
  var infowindows = [];

  map = new naver.maps.Map('map', {
    // center: new naver.maps.LatLng(36.31175, 127.3754709),
    center: new naver.maps.LatLng(parseFloat(dongLat), parseFloat(dongLon)),
    zoom: 17
  });

  const dongName = '{{ data.dong_name }}'
  const guName = '{{  data.gu_name  }}'

  var replace_str = "{{infra}}";
  //var infra_data = JSON.parse(replace_str);

  const urlEncoder = paramObj => {
    let arr = [];

    for (key in paramObj) {
      let param = key + '=' + encodeURIComponent(paramObj[key]);
      arr.push(param);
    }
    return arr.join('&'); //a=b&가=나&t=q
  }

  async function postData(url = '', data = {}) {
    // 옵션 기본 값은 *로 강조
    const response = await fetch(url, {
      method: 'POST', // *GET, POST, PUT, DELETE 등
      mode: 'cors', // no-cors, *cors, same-origin
      cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
      credentials: 'same-origin', // include, *same-origin, omit
      headers: {
        'Content-Type': 'application/json',
        // 'Content-Type': 'application/x-www-form-urlencoded',
      },
      redirect: 'follow', // manual, *follow, error
      referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
      body: JSON.stringify(data), // body의 데이터 유형은 반드시 "Content-Type" 헤더와 일치해야 함
    });
    return response.json(); // JSON 응답을 네이티브 JavaScript 객체로 파싱
  }


  async function getData(url = '', data = {}, header = { 'Content-Type': 'application/json' }) {

    url += '?' + urlEncoder(data)

    const response = await fetch(url, {
      method: 'GET',
      mode: 'cors', // no-cors, *cors, same-origin
      credentials: 'same-origin', // include, *same-origin, omit
      headers: header,
    });

    return response.json();
  }

  function drawMarker(names, lats, lons, cate) {

    markers = [];
    infowindows = [];

    if (cate == 'transportation'){
      var icon = {
        // url: '../../static/img/free-icon-exercise-2928160.png',
        content: '<i class="fa text-primary mr-2 fa-car">',
        size: new naver.maps.Size(22, 35),
        origin: new naver.maps.Point(0, 0),
        anchor: new naver.maps.Point(11, 35)
      };
      }else if (cate == 'safety'){
        var icon = {
          // url: '../../static/img/free-icon-exercise-2928160.png',
          content: '<i class="fa text-primary mr-2 fa-camera">',
          size: new naver.maps.Size(22, 35),
          origin: new naver.maps.Point(0, 0),
          anchor: new naver.maps.Point(11, 35)
        };
      }else if (cate == 'medical'){
        var icon = {
            // url: '../../static/img/free-icon-exercise-2928160.png',
            content: '<i class="fa text-primary mr-2 fa-heartbeat">',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };
      }else if (cate == 'facilities'){
        var icon = {
            // url: '../../static/img/free-icon-exercise-2928160.png',
            content: '<i class="fa text-primary mr-2 fa-shopping-bag">',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };
      }else if (cate == 'education'){
        var icon = {
            // url: '../../static/img/free-icon-exercise-2928160.png',
            content: '<i class="fa text-primary mr-2 fa-graduation-cap">',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };
      
      }else if (cate == 'parenting'){
        var icon = {
            content: '<i class="fa fa-child text-primary mr-2">',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };
      }else if (cate == 'starbucks_num'){
        var icon = {
            url: '../../static/img/free-icon-starbucks-5977591.png',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };
      }else if (cate == 'mc_num'){
        var icon = {
            url: '../../static/img/free-icon-mcdonalds-732217.png',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };
      }else if (cate == 'gym_num'){
        var icon = {
            url: '../../static/img/free-icon-exercise-2928160.png',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };
      }else if (cate == 'golf_num'){
        var icon = {
            url: '../../static/img/free-icon-golf-5929982.png',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };

      }else if (cate == 'safe_dlvr_num'){
        var icon = {
            url: '../../static/img/free-icon-courier-5310800.png',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };
      }else if (cate == 'leisure_num'){
        var icon = {
            url: '../../static/img/free-icon-bowling-ball-3390655.png',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };
      }else if (cate == 'park_num'){
        var icon = {
            url: '../../static/img/free-icon-park-2841090.png',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };
      }else if (cate == 'ani_hspt_num'){
        var icon = {
            url: '../../static/img/free-icon-puppy-1959967.png',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };
      }else if (cate == 'coliving_num'){
        var icon = {
            url: '../../static/img/free-icon-house-4820648.png',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };
      }else if (cate == 'vegan_cnt'){
        var icon = {
            url: '../../static/img/free-icon-vegan-4773476.png',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };
      }else if (cate == 'car_shr_num'){
        var icon = {
            url: '../../static/img/free-icon-toy-car-3094177.png',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };
      }else if (cate == 'kids_num'){
        var icon = {
            url: '../../static/img/free-icon-baby-girl-3320134.png',
            size: new naver.maps.Size(22, 35),
            origin: new naver.maps.Point(0, 0),
            anchor: new naver.maps.Point(11, 35)
          };
      }

    names.forEach((e, i) => {
      // var icon = {
      //   // url: '../../static/img/free-icon-exercise-2928160.png',
      //   content: '<i class="fa text-primary mr-2 fa-car">',
      //   size: new naver.maps.Size(22, 35),
      //   origin: new naver.maps.Point(0, 0),
      //   anchor: new naver.maps.Point(11, 35)
      // };

      markers.push(new naver.maps.Marker({
        map: map,
        position: new naver.maps.LatLng(lats[i], lons[i]),
        icon: icon
      }))

      infowindows.push(new naver.maps.InfoWindow({
        content: [
          '<div class="iw_inner">',
          '   <h3>' + names[i] + '</h3>',
          '</div>'
        ].join('')
      }));
    });

    for (let i = 0; i < markers.length; i++) {
      naver.maps.Event.addListener(markers[i], "click", function (e) {
        if (infowindows[i].getMap()) {
          infowindows[i].close();
        } else {
          infowindows[i].open(map, markers[i]);
        }
      });
    }
  }

  async function callbackInfra(ev) {
    ev.preventDefault();
    for (let i = 0; i < markers.length; i++) {
      markers[i].setMap(null)
      if (infowindows[i].getMap()) {
          infowindows[i].close();
        } else {
        }
    }
    console.dir(ev.target.dataset)
    cate = ev.target.dataset.query;
    reqParam = { "dong_name": dongName, "gu_name": guName, "cate": cate }
    res = await getData('/facility_info', reqParam);
    drawMarker(res.name, res.lat, res.lon, res.category)

  }

  document.querySelectorAll('.infra').forEach(e => {
    e.addEventListener('click', callbackInfra)
  })


</script>

<script>


















</script>


{% endblock %}